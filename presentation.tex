\documentclass[xcolor=table]{beamer}
\usepackage{beamerthemecern}
\usepackage{booktabs}
\usepackage{pgffor}
\usepackage{lstlinebgrd}
\usepackage{enumitem}
\usepackage{caption}
\usepackage{listings}

\definecolor{lightblue}{gray}{0.95}

% Customize caption for listing removing "Listing X"
\DeclareCaptionFormat{listing}{\colorbox{lightblue}{\parbox{\textwidth - 2mm}{#3}}}
\captionsetup[lstlisting]{format=listing,font={scriptsize,sf},justification=centering}

% Zebra colored listings
\newcommand\realnumberstyle[1]{}


\makeatletter
\newcommand{\zebra}[3]{%
    {\realnumberstyle{#3}}%
    \begingroup
    \lst@basicstyle
    \ifodd\value{lstnumber}%
        \color{#1}%
    \else
        \color{#2}%
    \fi
        \rlap{\hspace*{\lst@numbersep}%
        \color@block{\linewidth}{\ht\strutbox}{\dp\strutbox}%
        }%
    \endgroup
}
\makeatother

% Listing customization
\lstset{
    language=Python,                % choose the language of the code
    basicstyle=\fontfamily{pcr}\tiny,       % the size of the fonts that are used for the code
    tabsize=2,
    captionpos=b,
    %numbers=left,
    stepnumber=1,
    numberstyle=\tiny,
    numbersep=5pt,
    frame=lines,
    escapeinside={£}{£},
    breaklines=true,
    keywordstyle=\color[rgb]{0,0,1},
    commentstyle=\color[rgb]{0.133,0.545,0.133},
    stringstyle=\color[rgb]{1,0,0}
}

\makeatletter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% \btIfInRange{number}{range list}{TRUE}{FALSE}
%
% Test in int number <number> is element of a (comma separated) list of ranges
% (such as: {1,3-5,7,10-12,14}) and processes <TRUE> or <FALSE> respectively

\newcount\bt@rangea
\newcount\bt@rangeb

\newcommand\btIfInRange[2]{%
    \global\let\bt@inrange\@secondoftwo%
    \edef\bt@rangelist{#2}%
    \foreach \range in \bt@rangelist {%
        \afterassignment\bt@getrangeb%
        \bt@rangea=0\range\relax%
        \pgfmathtruncatemacro\result{ ( #1 >= \bt@rangea) && (#1 <= \bt@rangeb) }%
        \ifnum\result=1\relax%
            \breakforeach%
            \global\let\bt@inrange\@firstoftwo%
        \fi%
    }%
    \bt@inrange%
}
\newcommand\bt@getrangeb{%
    \@ifnextchar\relax%
        {\bt@rangeb=\bt@rangea}%
        {\@getrangeb}%
}
\def\@getrangeb-#1\relax{%
    \ifx\relax#1\relax%
        \bt@rangeb=100000%   \maxdimen is too large for pgfmath
    \else%
        \bt@rangeb=#1\relax%
    \fi%
}

\newcommand<>{\btLstHL}[1]{%
  \only#2{\btIfInRange{\value{lstnumber}}{#1}
        {\color{lightgray}\def\lst@linebackgroundcolor{\color@block}}
        {\def\lst@linebgrdcmd####1####2####3{}}}%
}%
\makeatother

\begin{document}
\title{Understanding applications performance}
\author{Marco Guerri}
\date{\today}

\frontcover
\frame{\titlepage}
\frame{\tableofcontents}
\section{Dirac Benchmark 2012}

\begin{frame}[fragile]{Dirac Benchmark 12}
    \begin{columns}[t]
        \begin{column}{0.55\textwidth}
            \setlist{leftmargin=4mm,label=$\diamond$}
            \begin{itemize}[noitemsep,topsep=0pt]
            \small
                \item Python benchmark, basically \textit{random.normalvariate()}
                 \item Considered an excellent predictor of performance of
                          LHCb MC jobs
            \end{itemize}
            \hypersetup{colorlinks=true, linkbordercolor=red, pdfborderstyle={/S/U/W 0.2}}
            \begin{lstlisting}[language=Python, caption=Source code avilable on
                                \href{https://github.com/DIRACGrid/DB12}{github},
                                linebackgroundcolor={\btLstHL<2>{6}}]
for i in range( iterations + 1):
    if i == 1:
      start = os.times()

    for _j in xrange( n ):
      t = random.normalvariate( 10, 1 )
      m += t
      m2 += t * t
      p += t
      p2 += t * t
            \end{lstlisting}
            \hypersetup{colorlinks=true, linkbordercolor=lightblue, pdfborderstyle={}}
        \end{column}
    \begin{column}{0.55\textwidth}
\def\arraystretch{1.2}
\arrayrulewidth=0.4pt

\begin{table}
\vspace{-7mm}
\scriptsize
\begin{tabular}{ l |  c |  c  }
   \multicolumn{3}{ c }{Hardware configuration} \\
   \hline
   & \textbf{Ivy Bridge} & \textbf{Haswell}  \\
  \hline
  CPU & E5-2650v2  & E5-2640v3 \\
%   & 8c/16t & 8c/16t  \\
%   & 2.6/3.4  & 2.6/3.4 \\
  RAM  & 64 GiB DDR3 & 128 GiB DDR4 \\
  OS & CentOS 7.3 & CentOS 7.3 \\
  \hline
\end{tabular}
\end{table}

\vspace{-5mm}
\begin{table}

\def\fourthrowcolor{}
\only<3>{\def\fourthrowcolor{\rowcolor{lightgray}}}

\scriptsize
\begin{tabular}{ l | c |  c |  c }
   \multicolumn{4}{ c }{Benchmark Results} \\
   \hline
   & \textbf{Ivy Bridge} & \textbf{Haswell} & $\Delta$  \\
  \hline
    $HS06_{32 t}$ & 350.19 & 360.87 & +3\%\\
    $HS06_{1 t}$ & 26.35 & 28.54 & +8\% \\
    $DB12_{32 t}$ & 10.98 & 12.27 & +12\% \\
    \fourthrowcolor $DB12_{1 t}$ & 20.99 & 30.17 & +44\% \\
\hline
\end{tabular}
\end{table}

    \end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{DB 12 - Functions profile}
\begin{lstlisting}[language=Python, caption=Functions profile on Ivy Bridge,
                   linebackgroundcolor={%
                        \btLstHL<2>{2}%
                        \btLstHL<3>{7}}]
#rank % cumulative%  function-name             image-name
0:  40.065  40.065  PyEval_EvalFrameEx        /lib64/libpython2.7.so.1.0
1:  10.345  50.410  _Py_add_one_to_index_C    /lib64/libpython2.7.so.1.0
2:   6.474  56.884  PyFloat_GetInfo           /lib64/libpython2.7.so.1.0
3:   3.743  60.627  _PyLong_Init              /lib64/libpython2.7.so.1.0
4:   3.600  64.227  PyFloat_FromDouble        /lib64/libpython2.7.so.1.0
5:   3.530  67.756  .text                     /usr/lib64/.../_randommodule.so
6:   3.089  70.845  Py_UniversalNewlineFread  /lib64/libpython2.7.so.1.0
7:   2.665  73.510  __ieee754_log_avx         /lib64/libm.so.6
8:   2.554  76.065  PyDict_GetItem            /lib64/libpython2.7.so.1.0
9:   2.273  78.337  _PyFloat_Unpack8          /lib64/libpython2.7.so.1.0
\end{lstlisting}

\vspace{-1mm}
\begin{lstlisting}[language=Python, caption=Functions profile on Haswell,
                   linebackgroundcolor={%
                        \btLstHL<2>{2}%
                        \btLstHL<3>{7}}]
#rank % cumulative%  function-name             image-name
0:  40.061  40.061  PyEval_EvalFrameEx        /lib64/libpython2.7.so.1.0
1:  10.344  50.406  _Py_add_one_to_index_C    /lib64/libpython2.7.so.1.0
2:   6.474  56.879  PyFloat_GetInfo           /lib64/libpython2.7.so.1.0
3:   3.743  60.622  _PyLong_Init              /lib64/libpython2.7.so.1.0
4:   3.599  64.222  PyFloat_FromDouble        /lib64/libpython2.7.so.1.0
5:   3.529  67.751  .text                     /usr/lib64/.../_randommodule.so
6:   3.089  70.840  Py_UniversalNewlineFread  /lib64/libpython2.7.so.1.0
7:   2.665  73.504  __ieee754_log_avx         /lib64/libm.so.6
8:   2.554  76.059  PyDict_GetItem            /lib64/libpython2.7.so.1.0
9:   2.273  78.331  _PyFloat_Unpack8          /lib64/libpython2.7.so.1.0
\end{lstlisting}

\end{frame}

\begin{frame}[fragile]{DB 12 - PyEval\_EvalFramEx}

\begin{columns}[t]
    
\begin{column}{0.5\textwidth}
\vspace{-5mm}
\setlist{leftmargin=1mm,label=$\diamond$}
\begin{itemize}
    \small
    \item Python source code is compiled into bytecode
    \item Bytecode is executed by interpreter (CPython)
\end{itemize}
\begin{lstlisting}[language=Python, caption=Function disassembly,
                   linebackgroundcolor={\btLstHL<2>{1-5}%
                                        \btLstHL<3>{6-17}%
                                        \btLstHL<3>{6-17}%
                                        \btLstHL<4>{12}}]
>>> def myfunc():
...     a = 120
...     b = a*10
...     return b
... 
>>> import dis
>>> dis.dis(myfunc)
  2           0 LOAD_CONST         1 (120)
              3 STORE_FAST         0 (a)

  3           6 LOAD_FAST          0 (a)
              9 LOAD_CONST         2 (10)
             12 BINARY_MULTIPLY     
             13 STORE_FAST         1 (b)

  4          16 LOAD_FAST          1 (b)
             19 RETURN_VALUE  
\end{lstlisting}
\end{column}

\begin{column}{0.5\textwidth}
\vspace{-5mm}
\begin{lstlisting}[language=c, caption=Excerpt from PyEval\_EvalFrameEx,
                   linebackgroundcolor={\btLstHL<4>{8}}]
switch (opcode) {
    case NOP:
        <NOP Instruction>
        break;
    case LOAD_FAST:
        <LOAD_FAST Instruction>
        break;
    case LOAD_CONST:
        <LOAD_CONST Instruction>
        break;
    case STORE_FAST:
        <STORE_FAST Instruction>
        break;
    case POP_TOP:
        <POP_TOP Instruction>
        break;
    case ROT_TWO:
        <ROT_TWO Instruction>
        break;
    [...]
    case UNARY_CONVERT:
        <UNARY_CONVERT Instruction>
        break;
    [..]
}
\end{lstlisting}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]{DB 12 - Profiling}{Only}

\begin{table}
\def\firstrowcolor{}
\def\secondrowcolor{}
\def\thirdrowcolor{}
\def\fourthrowcolor{}
\def\fifthrowcolor{}
\def\sixthrowcolor{}
\def\seventhrowcolor{}
\def\eighthrowcolor{}
\def\ninethrowcolor{}
\def\tenthrowcolor{}
\def\eleventhrowcolor{}
\def\twelvethrowcolor{}
\def\thirteenthrowcolor{}
\def\fourteenthrowcolor{}

\only<2>{\def\firstrowcolor{\rowcolor{lightgray}}}
\only<3>{\def\secondrowcolor{\rowcolor{lightgray}}}
\only<4>{\def\thirdrowcolor{\rowcolor{lightgray}}}
\only<5>{\def\fourthrowcolor{\rowcolor{lightgray}}}
\only<6>{\def\fifthrowcolor{\rowcolor{lightgray}}}
\only<7>{\def\sixthrowcolor{\rowcolor{lightgray}}}
\only<8>{\def\seventhrowcolor{\rowcolor{lightgray}}}
\only<9>{\def\eighthrowcolor{\rowcolor{lightgray}}}
\only<10>{\def\ninethrowcolor{\rowcolor{lightgray}}}
\only<11>{\def\tenthrowcolor{\rowcolor{lightgray}}}
\only<12>{\def\eleventhrowcolor{\rowcolor{lightgray}}}
\only<13>{\def\twelvethrowcolor{\rowcolor{lightgray}}}
\only<14>{\def\thirteenthrowcolor{\rowcolor{lightgray}}}
\only<15>{\def\fourteenthrowcolor{\rowcolor{lightgray}}}
\scriptsize
\begin{tabular}{ l |  r |  r | r }
   \multicolumn{4}{ c }{Performance statistics} \\
   \hline
   & \textbf{Ivy Bridge} & \textbf{Haswell} &  $\Delta$ \\
    \hline
  \firstrowcolor task-clock & 34725.557061  & 24105.686437 &  10s\\
  \secondrowcolor context-switches & 1,757  & 1,220 & -30\% \\
  \thirdrowcolor cpu-migrations & 0  & 1 &  \\
  \fourthrowcolor page-faults & 77,735  & 77,727 &  -0.01\% \\
  \fifthrowcolor cycles & 115,880,566,912  & 79,856,590,321 &  \\
  \sixthrowcolor stalled-cycles-frontend & 33,935,812,197  & -  &  \\
  \seventhrowcolor instructions & 196,423,070,931  & 196,279,702,821 & -0.07\% \\
  \eighthrowcolor branches & 39,007,221,715  & 38,988,806,436 & -0.04\%  \\
  \ninethrowcolor \fourteenthrowcolor branch-misses & 771,858,119  & 148,049,799 & -80\% \\
  \tenthrowcolor L1-dcache-loads & 65,738,912,645  & 65,709,868,550 & -0.4\% \\
  \eleventhrowcolor L1-dcache-load-misses & 223,445,275  & 190,642,933 & -14.6\% \\
  \twelvethrowcolor LLC-loads & 18,182,616  & 17,276,409 & -5\% \\
  \thirteenthrowcolor LLC-load-misses & 12,658,059  & 12,296,728 & -2.8\%  \\
  \hline
\end{tabular}
\end{table}
\setlist{leftmargin=10mm,label=$\diamond$}
\begin{minipage}[t][10mm][t]{\textwidth}
\begin{itemize}
    \small
    % Why the first item is not vertically aligned?
    \item<2|only@2> \vspace{1.01mm} Runtime in milliseconds: 10s difference
    \item<2|only@2> \vspace{1.01mm} Looking for architectural explanation 
                                    behind additional speedup
    \item<3|only@3> Context switches most likeley due to timer softirq
    \item<3|only@3> 500 more context switches on Ivy Bridge, cost is negligible
    \item<4|only@4> One more CPU migration on Haswell, cost is negligible
    \item<5|only@5> 8 more page-faults on Ivy Bridge, cost is negligible
    \item<8|only@8> Same number of instructions executed
    \item<9|only@9> Same number of branches
    \item<10|only@10> 623808320 more mispredicted branches on Ivy Bridge
    \item<10|only@10> 20 cycles per mispredicted branch @ ~3.4GHz = 4s
    \item<11|only@11> Negligible difference in L1d loads
    \item<12|only@12> 32802342 more misses on Ivy Bridge
    \item<12|only@12> 10 cycles per L1 miss, assuming it hits L2 = \textless 1s
\end{itemize}
\end{minipage}
% Ivy Bridge Profile
%      34725.557061      task-clock (msec)         #    1.000 CPUs utilized          
%             1,757      context-switches          #    0.051 K/sec                  
%                 0      cpu-migrations            #    0.000 K/sec                  
%            77,735      page-faults               #    0.002 M/sec                  
%   115,880,566,912      cycles                    #    3.337 GHz                      (44.45%)
%    33,935,812,197      stalled-cycles-frontend   #   29.29% frontend cycles idle     (44.45%)
%   196,423,070,931      instructions              #    1.70  insn per cycle         
%                                                  #    0.17  stalled cycles per insn  (55.56%)
%    39,007,221,715      branches                  # 1123.300 M/sec                    (55.56%)
%       771,858,119      branch-misses             #    1.98% of all branches          (55.56%)
%    65,738,912,645      L1-dcache-loads           # 1893.099 M/sec                    (44.44%)
%       223,445,275      L1-dcache-load-misses     #    0.34% of all L1-dcache hits    (22.22%)
%        18,182,616      LLC-loads                 #    0.524 M/sec                    (22.22%)
%        12,658,059      LLC-load-misses           #   69.62% of all LL-cache hits     (33.33%)
%      34.734003622 seconds time elapsed

% Haswell profile
%      24105.686437      task-clock (msec)         #    1.000 CPUs utilized          
%             1,220      context-switches          #    0.051 K/sec                  
%                 1      cpu-migrations            #    0.000 K/sec                  
%            77,727      page-faults               #    0.003 M/sec                  
%    79,856,590,321      cycles                    #    3.313 GHz                      (50.00%)
%   196,279,702,821      instructions              #    2.46  insn per cycle           (62.50%)
%    38,988,806,436      branches                  # 1617.411 M/sec                    (62.51%)
%       148,049,799      branch-misses             #    0.38% of all branches          (62.51%)
%    65,709,868,550      L1-dcache-loads           # 2725.907 M/sec                    (62.50%)
%       190,642,933      L1-dcache-load-misses     #    0.29% of all L1-dcache hits    (25.00%)
%        17,276,409      LLC-loads                 #    0.717 M/sec                    (24.99%)
%        12,296,728      LLC-load-misses           #   71.18% of all LL-cache hits     (37.50%)
%
%      24.117095520 seconds time elapsed


\end{frame}
\begin{frame}[fragile]{DB 12 - Mispredicted branches (CC7)}

\setlist{leftmargin=1mm,label=$\diamond$}
\begin{lstlisting}[language=Python, caption=Mispredicted branches on Ivy Bridge - function annotation,
                   linebackgroundcolor={\btLstHL<2->{3}}]
Samples: 142K of event 'branch-misses:pp', Event count (approx.): 889919468
Overhead  Command  Shared Object        Symbol
  88.53%  python   libpython2.7.so.1.0  [.] PyEval_EvalFrameEx
   5.81%  python   libpython2.7.so.1.0  [.] 0x00000000000477da
   4.27%  python   libm-2.17.so         [.] __ieee754_log_avx
   1.09%  python   libpython2.7.so.1.0  [.] PyBool_FromLong
   0.03%  python   libpython2.7.so.1.0  [.] PyInt_FromLong
\end{lstlisting}

\vspace{-5mm}
\begin{columns}[t]
\begin{column}{0.45\textwidth}<3->
\begin{lstlisting}[language=Python, caption=Assembly annotation on Ivy Bridge,
                   linebackgroundcolor={\btLstHL<4->{4}}]
          xor    %ecx,%ecx
          mov    %rdx,%rbp
          mov    (%rsi,%rdi,8),%rsi
 45.25%   jmpq   fffffffffff22300
          lea    0x2(%r9),%rbx
          movzbl -0x1(%rbx),%eax
          movzbl -0x2(%rbx),%ecx
\end{lstlisting}
\end{column}
\begin{column}{0.6\textwidth}<6->
\begin{lstlisting}[language=Python, caption=Corresponding C code,
                   linebackgroundcolor={\btLstHL<7->{4}}]
#define FAST_DISPATCH() { \
    if (!_Py_TracingPossible) { \
        f->f_lasti = INSTR_OFFSET(); \
        goto *opcode_targets[*next_instr++]; \
    } \
    goto fast_next_opcode;\
}
\end{lstlisting}

\end{column}
\end{columns}
\begin{itemize}
    \footnotesize
    \item<5-> Actually a \textbf{jmp *rsi}
    \item<8-> Dispatches next opcode to corresponding case branch without \textit{continue}. Other branch mispredictions are on the same FAST\_DISPATCH() macro.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{DB 12 - Mispredicted branches (SLC6)}

\setlist{leftmargin=1mm,label=$\diamond$}
\vspace{-5mm}
\begin{columns}[t]
\begin{column}{0.6\textwidth}
\begin{lstlisting}[language=Python, caption=Assembly annotation on Ivy Bridge (SLC6),
                   linebackgroundcolor={\btLstHL<2->{8}}]
        movl   $0x2,0x58(%rsp)
        jmpq   127
        nop
        lea    _PyUnicode_TypeRecords+0xc094,%rsi
        mov    %r8d,%eax
        movslq (%rsi,%rax,4),%rax
        add    %rsi,%rax
 97.40  jmpq   ffffffca30b2f870
        nop
        cmpb   $0x7a,(%r14)
        je     366
        mov    _PyImport_DynLoadFiletab+0x318,%rax
        mov    (%rax),%eax
        mov    %eax,(%r8)
        addl   $0x1,0x80(%r12)
\end{lstlisting}
\end{column}
\begin{column}{0.4\textwidth}
\begin{lstlisting}[language=Python, caption=Corresponding C code,
                   linebackgroundcolor={\btLstHL<7->{4}}]
/* Main switch on opcode */
READ_TIMESTAMP(inst0);

switch (opcode) {

    case NOP:
        goto fast_next_opcode;

    case LOAD_FAST:
        x = GETLOCAL(oparg);
        if (x != NULL) {
            Py_INCREF(x);
            PUSH(x);
            goto fast_next_opcode;
        }
\end{lstlisting}

\end{column}
\end{columns}
\begin{itemize}
    \footnotesize
    \item<2-> Again indirect jump \textbf{jmp *rax}
    \item<3-> FAST\_DISPATCH() not supported in Python 2.6.6, all 
    mispredictions happen on switch statement
\end{itemize}
\end{frame}
\backcover

\end{document}
    
